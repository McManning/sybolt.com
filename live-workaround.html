<!DOCTYPE html>

<html>
<head>
    <style>
        html, body {
            background: #000; 
            margin: 0;   
            padding: 0;
            height: 100%;
        }
        div {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
        }
    </style>
</head>
<body>

<div id="player-container">
    <div id="live-offline"><h1>OFFLINE</h1></div>
    <div id="live-error" style="display:none;"><h1>Unknown Error</h1></div>
    <div id="live-player-container" style="display:none;">
        <div id="live-player"><!-- Contents will be overwritten by Flowplayer --></div>
    </div>
</div>

<script type="text/javascript" src="https://releases.flowplayer.org/js/flowplayer-3.2.13.js"></script>
<script type="text/javascript" src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<script>

$(function() {
    $f('live-player', {
        src:"https://releases.flowplayer.org/swf/flowplayer-3.2.18.swf",
        wmode: "opaque" // This allows the HTML to hide the flash content
    }, {
        clip: {
            url: 'test',
            live: true,
            scaling: "fit",
            provider: "rtmp",
            autoPlay: true
        },
        onBeforePause: function() {
            return false;
        },
        plugins: {
            rtmp: {
                url: "flowplayer.rtmp-3.2.13.swf",
                netConnectionUrl: '',
                inBufferSeek: false,
                rtmpt: false // Disable HTTP tunneling (fails for HTTPS)
            },
            controls: {
                backgroundColor: 'transparent',
                backgroundGradient: 'none',
                progressColor:'#685475',
                bufferColor: '#dfcd6a',
                autoHide: true,
                
                // Control hiding 
                all: false,
                play: false,
                volume: true,
                mute: true,
                time: false,
                fullscreen: true,
                scrubber: true,
                scrubberHeightRatio: 0.1,
                scrubberBarHeightRatio: 0.1,
                sliderColor: '#ffffff'
            }
            
        },
        canvas: {
            backgroundColor: '#2e2c2a',
            backgroundGradient: 'none'
        }
    });
    
    function startStream(json) {
        publishing = true;

        // Hide any error messages, and activate our player
        $('#live-error').hide();
        $('#live-offline').hide();
        $('#live-player-container').show();

        if (!$f('live-player') || !$f('live-player').isLoaded()) {
            // If we're not loaded yet, configure a new player instance
            console.log('Initializing player');
            
            $f('live-player', {
                src:"https://releases.flowplayer.org/swf/flowplayer-3.2.18.swf",
                wmode: "opaque" // This allows the HTML to hide the flash content
            }, {
                clip: {
                    url: 'rtmp://sybolt.com:1935/live',
                    live: true,
                    scaling: "fit",
                    provider: "rtmp",
                    autoPlay: true
                },
                onBeforePause: function() {
                    return false;
                },
                plugins: {
                    rtmp: {
                        url: "flowplayer.rtmp-3.2.13.swf",
                        netConnectionUrl: json.rtmp_url,
                        inBufferSeek: false,
                        rtmpt: false // Disable HTTP tunneling (fails for HTTPS)
                    },
                    controls: {
                        backgroundColor: 'transparent',
                        backgroundGradient: 'none',
                        progressColor:'#685475',
                        bufferColor: '#dfcd6a',
                        autoHide: true,
                        
                        // Control hiding 
                        all: false,
                        play: false,
                        volume: true,
                        mute: true,
                        time: false,
                        fullscreen: true,
                        scrubber: true,
                        scrubberHeightRatio: 0.1,
                        scrubberBarHeightRatio: 0.1,
                        sliderColor: '#ffffff'
                    }
                    
                },
                canvas: {
                    backgroundColor: '#2e2c2a',
                    backgroundGradient: 'none'
                }
            });
            
            // FORCE clip playback (as sometimes it doesn't auto-play when loaded)
            $f('live-player').play({url: 'test'});
            
        } else if (!$f('live-player').isPlaying()) {
            // @todo source switching, if the new stream_path is different
            console.log('Loading Source playback');
            
            // If it's already loaded, just play the specified stream
            $f('live-player').play({url: 'test'});
        }
    }

    function stopStream() {

        if (publishing) {
            publishing = false;
            // @todo stop calling this if we're already offline
        
            // Hide any error/player, and show the generic offline message
            $('#live-error').hide();
            $('#live-player-container').hide();
            $('#live-offline').show();
            
            // Stop playback
            if ($f('live-player')) {
                $f('live-player').stop();
            }
        }
        
        // @todo update viewer count and icons
    }

    function setStreamError(error) {
        // Show an error message
        $('#live-offline').hide();
        $('#live-player-container').hide();
        $('#live-error')
            .show()
            .find('h1')
                .html('Connection Error: ' + error);
  
        // Stop playback
        if ($f('live-player')) {
            $f('live-player').stop();
        }
    }

    function updateLiveStatus() {
        
        $.getJSON('https://sybolt.com/live/status')
            .done(function(json) {
                console.log(json);

                // {"publishing": false, "rtmp_url": "rtmp://dev.sybolt.com:1935/live"}
                // {"publisher": {"ip": "75.118.83.160", "online": true, "id": "11266045856", "name": "Publisher"}, "publishing": true, "rtmp_url": "rtmp://dev.sybolt.com:1935/live", "clients": [], "stream_path": "test", "video": {"width": "1280", "codec": "H264", "frame_rate": "25", "height": "720"}, "audio": {"channels": "2", "profile": "LC", "codec": "AAC", "sample_rate": "48000"}}
                // {"publisher": {"ip": "75.118.83.160", "online": true, "id": "21266045856", "name": "Publisher"}, "publishing": true, "rtmp_url": "rtmp://dev.sybolt.com:1935/live", "clients": [{"ip": "73.178.208.242", "online": true, "id": "11236455666", "name": "Viewer 73.178.208.242"}], "stream_path": "test", "video": {"width": "1280", "codec": "H264", "frame_rate": "25", "height": "720"}, "audio": {"channels": "2", "profile": "LC", "codec": "AAC", "sample_rate": "48000"}}
                if (json.error) {
                    setStreamError(json.error);
                } else {

                    if (json.publishing && !publishing) {
                        startStream(json);
                    }

                    if (!json.publishing && publishing) {
                        stopStream();
                    }
                }
            })
            .fail(function() {
                setStreamError('Error while syncing to Live API');
            });

        setTimeout(updateLiveStatus, 5000);
    }

    updateLiveStatus();
});

</script>
</body>
</html>
