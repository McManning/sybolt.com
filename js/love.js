
Highcharts.pinkTheme = {
    colors: ["#81C784", "#64b5f6", "#EF5350" /* Add more for more color options */],
    chart: {
        backgroundColor: '#EF5350',
        style: {
            fontFamily: "'Roboto', sans-serif"
        },
        plotBorderColor: '#212121'
    },
    xAxis: {
        gridLineColor: '#212121',
        labels: {
            style: {
                color: '#FFFFFF'
            }
        }
    },
    yAxis: {
        gridLineColor: '#212121',
        labels: {
            style: {
                color: '#E0E0E3'
            }
        }
    },
    tooltip: {
        backgroundColor: 'rgba(0, 0, 0, 0.85)',
        style: {
            color: '#F0F0F0'
        }
    },
    plotOptions: {
        series: {
            dataLabels: {
                color: '#B0B0B3'
            },
            marker: {
                lineColor: '#333'
            }
        },
        boxplot: {
            fillColor: '#505053'
        },
        candlestick: {
            lineColor: 'white'
        },
        errorbar: {
            color: 'white'
        }
    },
    legend: {
        itemStyle: {
            color: '#E0E0E3'
        },
        itemHoverStyle: {
            color: '#FFF'
        },
        itemHiddenStyle: {
            color: '#606063'
        }
    },
    credits: {
        style: {
            color: '#EF5350'
        }
    },
    labels: {
        style: {
            color: '#707073'
        }
    },

    drilldown: {
        activeAxisLabelStyle: {
            color: '#F0F0F3'
        },
        activeDataLabelStyle: {
            color: '#F0F0F3'
        }
    },

    navigation: {
        buttonOptions: {
            symbolStroke: '#DDDDDD',
            theme: {
                fill: '#505053'
            }
        }
    },

    // scroll charts
    rangeSelector: {
        buttonTheme: {
            fill: '#505053',
            stroke: '#000000',
            style: {
                color: '#CCC'
            },
            states: {
                hover: {
                    fill: '#707073',
                    stroke: '#000000',
                    style: {
                        color: 'white'
                    }
                },
                select: {
                    fill: '#000003',
                    stroke: '#000000',
                    style: {
                        color: 'white'
                    }
                }
            }
        },
        inputBoxBorderColor: '#505053',
        inputStyle: {
            backgroundColor: '#333',
            color: 'silver'
        },
        labelStyle: {
            color: 'silver'
        }
    },

    navigator: {
        handles: {
            backgroundColor: '#666',
            borderColor: '#AAA'
        },
        outlineColor: '#CCC',
        maskFill: 'rgba(255,255,255,0.1)',
        series: {
            color: '#7798BF',
            lineColor: '#A6C7ED'
        },
        xAxis: {
            gridLineColor: '#505053'
        }
    },

    scrollbar: {
        barBackgroundColor: '#808083',
        barBorderColor: '#808083',
        buttonArrowColor: '#CCC',
        buttonBackgroundColor: '#606063',
        buttonBorderColor: '#606063',
        rifleColor: '#FFF',
        trackBackgroundColor: '#404043',
        trackBorderColor: '#404043'
    },

    // special colors for some of the..?
    legendBackgroundColor: 'rgba(0, 0, 0, 0.5)',
    background2: '#505053',
    dataLabelsColor: '#B0B0B3',
    textColor: '#C0C0C0',
    contrastTextColor: '#F0F0F3',
    maskColor: 'rgba(255,255,255,0.3)'
};

Highcharts.darkTheme = {
    colors: ["#64B5F6  ", "#81C784  ", "#EF5350" /* Add more for more color options */],
    chart: {
        backgroundColor: '#212121',
        style: {
            fontFamily: "'Roboto', sans-serif"
        },
        plotBorderColor: '#606063'
    },
    xAxis: {
        gridLineColor: '#707073',
        labels: {
            style: {
                color: '#FFFFFF'
            }
        },
        lineColor: '#707073',
        minorGridLineColor: '#505053',
        tickColor: '#707073',
        title: {
            style: {
                color: '#A0A0A3'
            }
        }
    },
    yAxis: {
        gridLineColor: '#707073',
        labels: {
            style: {
                color: '#E0E0E3'
            }
        },
        lineColor: '#707073',
        minorGridLineColor: '#505053',
        tickColor: '#707073',
        tickWidth: 1,
        title: {
            style: {
                color: '#A0A0A3'
            }
        }
    },
    tooltip: {
        backgroundColor: 'rgba(0, 0, 0, 0.85)',
        style: {
            color: '#F0F0F0'
        }
    },
    plotOptions: {
        series: {
            dataLabels: {
                color: '#B0B0B3'
            },
            marker: {
                lineColor: '#333'
            }
        },
        boxplot: {
            fillColor: '#505053'
        },
        candlestick: {
            lineColor: 'white'
        },
        errorbar: {
            color: 'white'
        }
    },
    legend: {
        itemStyle: {
            color: '#E0E0E3'
        },
        itemHoverStyle: {
            color: '#FFF'
        },
        itemHiddenStyle: {
            color: '#606063'
        }
    },
    credits: {
        style: {
            color: '#212121'
        }
    },
    labels: {
        style: {
            color: '#707073'
        }
    },

    drilldown: {
        activeAxisLabelStyle: {
            color: '#F0F0F3'
        },
        activeDataLabelStyle: {
            color: '#F0F0F3'
        }
    },

    navigation: {
        buttonOptions: {
            symbolStroke: '#DDDDDD',
            theme: {
                fill: '#505053'
            }
        }
    },

    // scroll charts
    rangeSelector: {
        buttonTheme: {
            fill: '#505053',
            stroke: '#000000',
            style: {
                color: '#CCC'
            },
            states: {
                hover: {
                    fill: '#707073',
                    stroke: '#000000',
                    style: {
                        color: 'white'
                    }
                },
                select: {
                    fill: '#000003',
                    stroke: '#000000',
                    style: {
                        color: 'white'
                    }
                }
            }
        },
        inputBoxBorderColor: '#505053',
        inputStyle: {
            backgroundColor: '#333',
            color: 'silver'
        },
        labelStyle: {
            color: 'silver'
        }
    },

    navigator: {
        handles: {
            backgroundColor: '#666',
            borderColor: '#AAA'
        },
        outlineColor: '#CCC',
        maskFill: 'rgba(255,255,255,0.1)',
        series: {
            color: '#7798BF',
            lineColor: '#A6C7ED'
        },
        xAxis: {
            gridLineColor: '#505053'
        }
    },

    scrollbar: {
        barBackgroundColor: '#808083',
        barBorderColor: '#808083',
        buttonArrowColor: '#CCC',
        buttonBackgroundColor: '#606063',
        buttonBorderColor: '#606063',
        rifleColor: '#FFF',
        trackBackgroundColor: '#404043',
        trackBorderColor: '#404043'
    },

    // special colors for some of the..?
    legendBackgroundColor: 'rgba(0, 0, 0, 0.5)',
    background2: '#505053',
    dataLabelsColor: '#B0B0B3',
    textColor: '#C0C0C0',
    contrastTextColor: '#F0F0F3',
    maskColor: 'rgba(255,255,255,0.3)'
};

var g_dataset = null;

function weightLanguage(percent) 
{
    var strings = [
        [90, 'loves'],
        [80, 'is really into'],
        [70, 'is somewhat into'],
        [60, 'slightly likes'],
        [50, 'is indifferent about'],
        [40, 'slightly dislikes'],
        [30, 'dislikes'],
        [20, 'definitely not into'],
        [0, 'hates']
    ];

    for (var i = 0; i < strings.length; i++) {
        if (percent >= strings[i][0]) {
            return strings[i][1];
        }
    }
}

function prefixLanguage(category) {
    if (category === 'Switch') {
        return '';
    }

    if (category === 'Vanilla' || category === 'Submissive' || category === 'Dominant') {
        return 'being';
    }

    if (category[0] === 'A' || category[0] === 'E' || category[0] === 'O') {
        return 'being an';
    }

    return 'being a';
}

/**
 * Comparator to sort on left individual's percentages (high first)
 */
function comparativeSortLeft(a, b)
{
    return b[1] - a[1];
}

/**
 * Comparator to sort on weighted averages (high first)
 */
function comparativeSortWeightedAverages(a, b)
{
    return b[3] - a[3];
}

function categoriesSortPercent(a, b)
{
    return b[1] - a[1];
}

function drawShippingAverages()
{
    Highcharts.setOptions(Highcharts.darkTheme);

    var categories = [], left = [], right = [], wavg = [];
    var comparator = comparativeSortLeft;
    var length = g_dataset.comparative.length;

    // Check for alt views
    var $analysis = $('section.analysis');

    if ($analysis.hasClass('sort-averages')) {
        comparator = comparativeSortWeightedAverages;
    }

    if ($analysis.hasClass('show-top-ten')) {
        comparator = comparativeSortWeightedAverages;
        length = 10;
    }

    // Sort our dataset
    g_dataset.comparative.sort(comparator);

    // Transform for the table
    for (var i = 0; i < length; i++) {
        categories.push(g_dataset.comparative[i][0]);
        left.push(g_dataset.comparative[i][1]);
        right.push(g_dataset.comparative[i][2]);
        wavg.push(g_dataset.comparative[i][3]);
    }

    $('#shipping-chart-container').highcharts({
        title: {
            text: ''
        },
        xAxis: {
            categories: categories
        },
        tooltip:{
            formatter: function(){
                //console.log(this);

                /*
                    this.x 'Brat <br> Brat Tamer'
                    point:
                    y: 5.333
                    series.name: 'Weighted Average', 'Chase', 'Mark', etc
                */

                if (this.series.name === 'Weighted Average') {
                    // Display average tooltip
                    return 'Weighted Average: ' + this.y + '%';
                } 
                else {
                    var category;

                    var options = this.x.split('<br>');
                    if (options.length < 2) {
                        category = this.x.trim();
                    } 
                    else {
                        // Split on the display break, and show the correct category
                        // based on which column we're hovering (left vs right)
                        if (this.series.name === g_dataset.individuals[0].name) {
                            category = options[0].trim();
                        }
                        else {
                            category = options[1].trim();
                        }
                    }

                    return this.series.name + '<br>' + this.y + '% ' + category;
                }
            }
        },
        series: [{
            type: 'column',
            name: g_dataset.individuals[0].name,
            data: left
        }, {
            type: 'column',
            name: g_dataset.individuals[1].name,
            data: right
        }, {
            type: 'spline',
            name: 'Weighted Average',
            // Averages data: [67.5, 78.5, 54, 39.5, 41.5, 36, 36.5, 72, 26.5, 19.5, 34, 22.5, 13.5, 16.5, 11.5, 13.5, 8, 9.5, 3.5, 3.5, 4.5],
            // Weighted averages following the equation:
            // avg - (avg - min(left, right)*(1 - min(left, right)/100))
            //data: [54.34, 78.155, 42.48, 14.135, 27.255, 19.2, 22.325, 63.07, 2.49, 3.495, 30.45, 21.315, 5.425, 16.08, 8.28, 8.44, 8, 6.21, 2.03, 2.03, 0],
            data: wavg,
            marker: {
                lineWidth: 2,
                lineColor: Highcharts.getOptions().colors[3],
                fillColor: 'white'
            }
        }]
    });
}

function drawIndividualAnalysisWeb($container, color, individual)
{
    var categories = [], percentages = [];

    // Sort our dataset
    individual.categories.sort(categoriesSortPercent);

    // Transform for the table
    for (var i = 0; i < 5; i++) {
        categories.push(individual.categories[i][0]);
        percentages.push(individual.categories[i][1]);
    }

    Highcharts.setOptions(Highcharts.pinkTheme);

    var top1 = individual.categories[0];
    var top2 = individual.categories[1];
    var bottom1 = individual.categories[individual.categories.length-1];
    var bottom2 = individual.categories[individual.categories.length-2];

    // Update labels
    $container.find('.person').html(individual.name);
    $container.find('.top-1').html(top1[0]);
    $container.find('.top-2').html(individual.categories[1][0]);
    $container.find('.bottom-1').html(bottom1[0]);
    $container.find('.bottom-2').html(bottom2[0]);

    $container.find('.top-phrase').html( 
        weightLanguage(top1[1]) + ' ' + prefixLanguage(top1[0]) + 
        ' <span class="relationship-single">' + top1[0] + '</span> and ' + 
        weightLanguage(top2[1]) + ' ' + prefixLanguage(top2[0]) + 
        ' <span class="relationship-single">' + top2[0] + '</span>'
    );

    $container.find('.bottom-phrase').html( 
        weightLanguage(bottom2[1]) + ' ' + prefixLanguage(bottom2[0]) + 
        ' <span class="relationship-single">' + bottom2[0] + '</span> and ' + 
        weightLanguage(bottom1[1]) + ' ' + prefixLanguage(bottom1[0]) + 
        ' <span class="relationship-single">' + bottom1[0] + '</span>'
    );

    $container.find('.chart-container').highcharts({
        colors: [color],
        chart: {
            polar: true,
            type: 'area'
        },
        title: {
            text: ''
        },
        pane: {
            size: '80%'
        },
        xAxis: {
            categories: categories,
            tickmarkPlacement: 'on',
            lineWidth: 0
        },
        yAxis: {
            gridLineInterpolation: 'polygon',
            lineWidth: 0,
            min: 0
        },
        tooltip: {
            shared: true,
            pointFormat: '<span style="color:{series.color}">Influence: <strong>{point.y:,.0f}%</strpng>'
        },
        legend: {
            enabled: false
        },
        series: [{
            data: percentages,
            pointPlacement: 'off'
        }]
    });
}

function drawSideBySideCharts()
{
    drawIndividualAnalysisWeb($('.side-by-side-left'), '#64B5F6', g_dataset.individuals[0]);
    drawIndividualAnalysisWeb($('.side-by-side-right'), '#81C784', g_dataset.individuals[1]);
}

function resetAnimations()
{

    // Highcharts rendering when we pass through each chart
    // Problem with scrollfire: If it's already visible on the page, it doesn't
    // test until a scroll event is fired once. 
    Materialize.scrollFire([
        {
            selector: '.side-by-side', 
            offset: 400, 
            callback: 'drawSideBySideCharts()'
        },
        {
            selector: '.analysis',
            offset: 400,
            callback: 'drawShippingAverages()'
        }
    ]);

    // Fire a fake scroll event, just to trigger scrollFire to start working.
    // Bit of a hack, but scrollfire doesn't add the listener until a scroll event.
    if (typeof Event === 'function') {
        window.dispatchEvent(new Event('scroll'));
    }

}

$(function() {
    $('select').material_select();

    $('.shipping-left, .shipping-right').dropdown({
        inDuration: 300,
        outDuration: 225,
        constrain_width: false, // Does not change width of dropdown to that of the activator
        hover: false, // Activate on hover
        gutter: 0, // Spacing from edge
        belowOrigin: true, // Displays dropdown below the button
        alignment: 'left' // Displays dropdown with edge aligned to the left of button
    });

    $('.shipping-list a').click(function() {
        // todo: changer

    });

    $('.try-another').click(function() {
        // Both html/body needed for IE support (meh)
        $('html, body').animate({ scrollTop: 350 }, 'slow');
        return false;
    });

    // TODO: Seems to be a (HighCharts?) bug where if we regenerate one
    // of the tables, most of them fail to show hover icons.
    // $('.sort-shipping').click(function() {
    //     var $analysis = $('section.analysis');

    //     $analysis
    //         .toggleClass('sort-default')
    //         .toggleClass('sort-averages');

    //     if ($analysis.hasClass('sort-default')) {
    //         $(this).html('sort by averages');
    //     }
    //     else {
    //         $(this).html('sort by default');
    //     }

    //     drawShippingAverages();
    // });

    // $('.top-shipping').click(function() {
    //     var $analysis = $('section.analysis');

    //     $analysis
    //         .toggleClass('show-top-ten');

    //     if ($analysis.hasClass('show-top-ten')) {
    //         $(this).html('show all');
    //     }
    //     else {
    //         $(this).html('show top 10');
    //     }

    //     drawShippingAverages();
    // });

    $.get('/love/ship/Chase/with/MarkMeltzer')
        .done(function(data) {
            g_dataset = data;
            resetAnimations();
        });
});
